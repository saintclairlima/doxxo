<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca ICMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .resumo-truncado { max-height: 8.5rem; /* ~5 linhas */ overflow: hidden; position: relative; }
        .resumo-truncado::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 3rem; background: linear-gradient(to top, white, transparent); }
        .loading-shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-white text-gray-900">

    <div id="app" class="min-h-screen flex flex-col items-center transition-all duration-500 pt-32">
        
        <div id="area-cabecalho" class="text-center mb-8 transition-all duration-500">
            <h1 class="text-5xl font-bold text-blue-600 tracking-tighter">Busca ICMS</h1>
        </div>

        <div id="container-busca" class="w-full max-w-2xl px-4 transition-all duration-500">
            <form id="formBusca" class="relative flex items-center" onsubmit="event.preventDefault(); realizarBusca();">
                <input type="text" id="inputConsulta" placeholder="Digite sua pesquisa sobre ICMS..." 
                    class="w-full p-4 pl-6 pr-16 text-lg border border-gray-200 rounded-full shadow-sm hover:shadow-md focus:shadow-md focus:outline-none transition-all">
                <button id="botaoBuscar" type="submit" class="absolute right-4 text-blue-600 hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </form>
        </div>

        <main id="area-resultados"
            class="hidden w-full max-w-4xl mt-10 px-6 flex flex-col gap-6 pb-10">

            <!-- Card de sumarização -->
            <section id="area-sumarizacao"
                class="p-6 border border-gray-100 rounded-xl shadow-sm bg-white
                    hover:bg-gray-50 transition-colors">

                <div class="flex items-center gap-2 mb-3 text-xs font-medium text-gray-400">
                    <h3 id="rotuloSumarizacao" class="font-semibold text-blue-800 uppercase tracking-wider text-sm"> ✨ Sumarizando resultados com IA </h3>
                </div>

                <div id="conteudoSumarizacao">
                    <div class="space-y-2">
                        <div class="h-4 w-full loading-shimmer rounded"></div>
                        <div class="h-4 w-5/6 loading-shimmer rounded"></div>
                        <div class="h-4 w-4/6 loading-shimmer rounded"></div>
                    </div>
                </div>

                <button id="botaoExpandirResumo" onclick="toggleResumoExpandido()" class="hidden mt-4 text-sm text-blue-600 hover:underline">
                    Mostrar mais
                </button>
            </section>

            <!-- Lista de resultados -->
            <section id="listaResultados" class="space-y-6 custom-scrollbar"></section>
        </main>
    </div>

    <script>
        const URL_API = "TAG_INSERCAO_URL_API";
        let textosRecuperados = [];
        let buscando = false;
        let sumarizando = false;

        let resumoCompleto = "";
        let resumoExpandido = false;

        async function realizarBusca() {
            if (buscando) return;
            buscando = true;
            exibirConteudoSumarizacaoCarregando();
            
            const pergunta = document.querySelector('#inputConsulta').value;
            if (!pergunta) return;

            const form = document.querySelector('#formBusca');

            const inputConsulta = document.querySelector('#inputConsulta');
            inputConsulta.disabled = true;

            const botaoBuscar = document.querySelector('#botaoBuscar');
            botaoBuscar.disabled = true;
            botaoBuscar.classList.add('opacity-50', 'cursor-not-allowed');

            // Ajuste de Layout: Sobe a barra e mostra os resultados
            document.querySelector('#app').classList.remove('pt-32');
            document.querySelector('#app').classList.add('pt-10');
            document.querySelector('#area-cabecalho').classList.add('scale-75', 'mb-2');
            document.querySelector('#area-resultados').classList.remove('hidden');

            const listaResultados = document.querySelector('#listaResultados');
            listaResultados.innerHTML = '<div class="space-y-4">' + Array(3).fill('<div class="h-24 w-full loading-shimmer rounded-xl"></div>').join('') + '</div>';

            try {
                const response = await fetch(`${URL_API}/doxxo/consulta?pergunta=${encodeURIComponent(pergunta)}&num_resultados=20&reranquear=true&colecao=icms`);
                const dados = await response.json();                
                textosRecuperados = dados.map(d => `${d.metadata.titulo} - ${d.metadata.subtitulo}\n${d.document}`);
                renderizarResultados(dados);
                sumarizarConteudo();
            } catch (error) {
                listaResultados.innerHTML = `<p class="text-red-500">Erro ao buscar documentos: ${error.message}</p>`;
            } finally {
                inputConsulta.disabled = false;
                botaoBuscar.disabled = false;
                botaoBuscar.classList.remove('opacity-50', 'cursor-not-allowed');
                buscando = false;  
            }
        }

        function getFormatoRelevancia(distancia){
            const base = "p-1 inline-block border rounded";
            if (distancia >= 0.6) {
                return { rotulo: "Alta", estilo: `${base} bg-green-100 text-green-800 border-green-200` };
            } else if (distancia >= 0.4) {
                return { rotulo: "Média", estilo: `${base} bg-yellow-100 text-yellow-800 border-yellow-200` };
            } else {
                return { rotulo: "Baixa", estilo: `${base} bg-red-100 text-red-800 border-red-200` };
            }
        }

        function renderizarResultados(dados) {
            const listaResultados = document.querySelector('#listaResultados');
            listaResultados.innerHTML = dados.map(item => {
                const score = item.rerank_score ? item.rerank_score : (1-item.distance)               
                const {rotulo, estilo} = getFormatoRelevancia(score);                
                return `
                    <div class="p-5 border border-gray-100 rounded-xl hover:bg-gray-50 transition-colors shadow-sm">
                        <div class="flex items-center gap-2 mb-2 text-xs font-medium text-gray-400">
                            <span class="bg-gray-100 px-2 py-1 rounded capitalize">${item.metadata.colecao}</span>
                            <span class="${estilo}">Relevância: ${rotulo} (${(score * 100).toFixed(1)}%)</span>
                        </div>
                        <h4 class="text-lg font-semibold text-blue-800 mb-2">
                            <a href="${URL_API}/doxxo/documento?url_documento=${item.metadata.fonte}" target="_blank">
                            ${item.metadata.titulo} - ${item.metadata.subtitulo}</a></h4>
                        <p class="text-gray-600 text-sm line-clamp-3">${item.document}</p>
                    </div>`
            }).join('');
        }

        function exibirConteudoSumarizacaoCarregando() {
            const rotuloSumarizacao = document.querySelector('#rotuloSumarizacao');
            rotuloSumarizacao.textContent = "✨ Sumarizando resultados com IA ";
            const conteudoSumarizacao = document.querySelector('#conteudoSumarizacao');
            conteudoSumarizacao.innerHTML = `
                    <div class="space-y-2">
                        <div class="h-4 w-full loading-shimmer rounded"></div>
                        <div class="h-4 w-5/6 loading-shimmer rounded"></div>
                        <div class="h-4 w-4/6 loading-shimmer rounded"></div>
                    </div>
                `;
            const botaoExpandir = document.querySelector('#botaoExpandirResumo');
            botaoExpandir.classList.add('hidden');
        }

        function atualizarConteudoSumarizacao(conteudoSumarizado) {
            const rotuloSumarizacao = document.querySelector('#rotuloSumarizacao');
            rotuloSumarizacao.textContent = "✨ Insights dos Resultados (gerado por IA)";
            const conteudoSumarizacao = document.querySelector('#conteudoSumarizacao');
            conteudoSumarizacao.innerHTML = conteudoSumarizado;
            const botaoExpandir = document.querySelector('#botaoExpandirResumo');
            botaoExpandir.textContent = "Mostrar mais";
            botaoExpandir.classList.remove('hidden');
            resumoExpandido = false;
        }

        async function sumarizarConteudo() {
            if (sumarizando || textosRecuperados.length === 0) return;
            sumarizando = true;
            
            const consulta = document.querySelector('#inputConsulta').value;
            exibirConteudoSumarizacaoCarregando();

            try {
                const response = await fetch(`${URL_API}/doxxo/sumarizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        consulta: consulta,
                        textos: textosRecuperados
                    })
                });

                const data = await response.json();
                resumoCompleto = data.resumo || "";
                resumoCompleto = `
                    <div id="textoResumo" class="text-sm text-gray-700 leading-relaxed resumo-truncado">
                        ${resumoCompleto.replace(/\n/g, "<br>")}
                    </div>
                `;
                atualizarConteudoSumarizacao(resumoCompleto);

            } catch (error) {
                const erroHTML = `<p class="text-red-500 text-xs italic">Erro ao gerar resumo.</p>`;
                conteudoSumarizacao.innerHTML = erroHTML;
            } finally {
                sumarizando = false;
            }
        }

        function toggleResumoExpandido() {
            const textoResumo = document.querySelector('#textoResumo');
            const botaoExpandir = document.querySelector('#botaoExpandirResumo');

            if (!textoResumo) return;

            resumoExpandido = !resumoExpandido;

            if (resumoExpandido) {
                textoResumo.classList.remove('resumo-truncado');
                botaoExpandir.textContent = "Mostrar menos";
            } else {
                textoResumo.classList.add('resumo-truncado');
                botaoExpandir.textContent = "Mostrar mais";
            }
        }
    </script>
</body>
</html>